define(["jquery","core/ajax","core/notification","core/str","core/templates"],function(l,o,r,d,t){return{generate:function(n){var e=l("#amount-"+n).val();var a=l("#publisherid-"+n).val();o.call([{methodname:"block_edupublisher_licence_generate",args:{amount:e,publisherid:a},done:function(e){l("#licencekeys-"+n).val(e)},fail:r.exception}])},generateNow:function(e){var n=l("#licencekeys-"+e).val();var a=l("#publisherid-"+e).val();o.call([{methodname:"block_edupublisher_licence_generatenow",args:{licencekeys:n,publisherid:a},done:function(){l("#licencekeys-"+e).val("")},fail:r.exception}])},generateStepSubmit:function(e,n){if(n==1){l("#"+e).find(".package_choice").each(function(e,n){if(!l(n).prop("checked")){l(n).parent().find(".package_amount").val("")}})}},generateStepUi:function(o,e){if(e==1){l("#"+o).find(".package_choice").each(function(e,n){var a=l(n);var i=l(n).closest(".line");var c=l("#type-"+o).val();var t=parseInt(i.find(".package_amount").val());d.get_strings([{key:"licence_amount_usages",component:"block_edupublisher",param:{amount:t}},{key:"licence_amount_infinite",component:"block_edupublisher"},{key:"licence_amount_none",component:"block_edupublisher"}]).done(function(e){if(c==2&&a.prop("checked")||t>0){i.find(".package_choice").prop("checked",true);i.find(".package_amount_lbl").html(e[0]);i.find("a.btn").addClass("active");i.addClass("active")}else if(c==2&&a.prop("checked")||t==-1){i.find(".package_choice").prop("checked",true);i.find(".package_amount_lbl").html(e[1]);i.find("a.btn").addClass("active");i.addClass("active")}else{i.find(".package_choice").prop("checked",false);i.find(".package_amount_lbl").html(e[2]);i.find("a.btn").removeClass("active");i.removeClass("active")}}).fail(r.exception)})}},loadList:function(t){var e=l("#publisherid-"+t).val();o.call([{methodname:"block_edupublisher_licence_list",args:{publisherid:e},done:function(e){try{e=JSON.parse(e);var n=Object.keys(e);var a=l("#licences-"+t).empty();if(n.length==0){d.get_strings([{key:"licences_none",component:"block_edupublisher"}]).done(function(e){l(a).append(l("<li>").html(e[0]))}).fail(r.exception)}else{for(var i=0;i<n.length;i++){var c=e[n[i]];l(a).append(l("<li>").append(l("<a>").attr("href","#").html(c.licencekey)))}}}catch(e){console.error("Invalid response")}},fail:r.exception}])},redeem:function(i,e){if(typeof e==="undefined"){e=0}var c=this;var n=l("#addlicence-"+i+' input[type="text"]').val();o.call([{methodname:"block_edupublisher_licence_redeem",args:{licencekey:n,targetid:e},done:function(n){try{n=JSON.parse(n);if(typeof n.error!=="undefined"){r.alert(n.heading,n.error)}else if(typeof n.success!=="undefined"){top.location.href=top.location.href}else if(typeof n.options!=="undefined"){n.myuniqid=i;require(["core/modal_factory","core/modal_events"],function(e,a){e.create({type:e.types.SAVE_CANCEL,title:n.heading,body:t.render("block_edupublisher/licence_redeem_options",n)},undefined).done(function(e){e.show();var n=e.getRoot();n.on(a.save,function(){var e=l("#targetid-"+i).val();c.redeem(i,e)})})})}}catch(e){console.error("Invalid response",e)}},fail:r.exception}])}}});