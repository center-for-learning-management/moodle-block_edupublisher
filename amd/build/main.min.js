define(["jquery","core/ajax","core/notification","core/str","core/templates","core/url","core/modal_factory"],function(c,l,d,s,u,r,n){return{searchid:0,loadpositions:{},cancelPackageForm:function(i){s.get_strings([{key:"removal:title",component:"block_edupublisher"},{key:"removal:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(e){d.confirm(e[0],e[1],e[2],e[3],function(){top.location.href=i})}).fail(d.exception)},clickImportConfirmation:function(){c('#page-content div[role="main"] form[action*="/edupublisher/pages/import.php"]').submit()},confirmDeleteGroup:function(i){s.get_strings([{key:"groups:remove:title",component:"block_edupublisher"},{key:"groups:remove:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(e){d.confirm(e[0],e[1],e[2],e[3],function(){top.location.href=i})}).fail(d.exception)},confirmRemoval:function(i){s.get_strings([{key:"removal:title",component:"block_edupublisher"},{key:"removal:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(e){d.confirm(e[0],e[1],e[2],e[3],function(){top.location.href=i})}).fail(d.exception)},exportCourseWarning:function(){var e=c("#id_exportcourse").is(":checked");if(!e){s.get_strings([{key:"exportcourse",component:"block_edupublisher"},{key:"exportcourse_help",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done(function(e){d.confirm(e[0],e[1],e[2],e[3],function(){},function(){c("#id_exportcourse").prop("checked",true)})}).fail(d.exception)}},initImportSelection:function(i,t,o){s.get_strings([{key:"import",component:"core"}]).done(function(e){n.create({title:e[0],body:u.render("block_edupublisher/init_import_selection",{packageid:i,courseid:t,allowsubcourses:o})}).done(function(e){e.show()})}).fail(d.exception)},initImportLoadGo:function(e){var i=c("#courseid-"+e).val();var t=c("#packageid-"+e).val();var o=c("#sectionid-"+e).val();var n=c("#assubcourse-"+e).prop("checked")?1:0;top.location.href=r.fileUrl("/blocks/edupublisher/pages/import.php","?package="+t+"&course="+i+"&section="+o+"&assubcourse="+n)},initImportLoadCourses:function(r,a){var i=this;c("#courseid-"+r).empty().attr("disabled","disabled");c("#sectionid-"+r).empty().attr("disabled","disabled");var t=+c("#packageid-"+r).val();s.get_strings([{key:"loading",component:"core"}]).done(function(e){c("#courseid-"+r+", #sectionid-"+r).append(c("<option>").html(e[0]));l.call([{methodname:"block_edupublisher_init_import_load_courses",args:{packageid:t},done:function(o){var o=JSON.parse(o);c("#courseid-"+r).empty();if(typeof o.courses!=="undefined"&&Object.keys(o.courses).length>0){c("#courseid-"+r).removeAttr("disabled");var n=0;Object.keys(o.courses).forEach(function(e){var i=o.courses[e];var t=c("<option>").attr("value",i.id).html(i.fullname);c("#courseid-"+r).append(t);if(n==0&&typeof a!=="undefined"){n=i.id}if(typeof a!=="undefined"&&a==i.id){t.attr("selected","selected")}});i.initImportLoadSections(r)}else{s.get_strings([{key:"error",component:"core"}]).done(function(e){c("#courseid-"+r).append(c("<option>").html(e[0]));c("#sectionid-"+r).append(c("<option>").html(e[0]))}).fail(d.exception);d.show("error","no courses")}},fail:d.exception}])}).fail(d.exception)},initImportLoadSections:function(n){c("#sectionid-"+n).empty().attr("disabled","disabled");s.get_strings([{key:"loading",component:"core"}]).done(function(e){c("#sectionid-"+n).append(c("<option>").html(e[0]));l.call([{methodname:"block_edupublisher_init_import_load_sections",args:{courseid:+c("#courseid-"+n).val()},done:function(t){var t=JSON.parse(t);c("#sectionid-"+n).empty();if(typeof t.sections!=="undefined"&&Object.keys(t.sections).length>0){c("#sectionid-"+n).removeAttr("disabled");var o=0;Object.keys(t.sections).forEach(function(e){var i=t.sections[e];if(!i.name){i.name="#"+o}c("#sectionid-"+n).append(c("<option>").attr("value",i.id).html(i.name));o++})}else{s.get_strings([{key:"error",component:"core"}]).done(function(e){c("#sectionid-"+n).append(c("<option>").html(e[0]))}).fail(d.exception)}},fail:d.exception}])}).fail(d.exception)},injectEnrolButton:function(e,i){var t={isguestuser:i,url:r.relativeUrl("/blocks/edupublisher/pages/self_enrol.php",{id:e})};u.render("block_edupublisher/inject_enrol_button",t).then(function(e,i){u.prependNodeContents("#page-content #region-main-box",e,i);c(".course-guestaccess-infobox").remove()}).fail(d.exception)},preparePackageForm:function(t){require(["jquery"],function(e){if(typeof t!=="undefined"){t=t.split(",");for(var i=0;i<t.length;i++){if(t[i]=="default"){continue}if(!e('div[role="main"] #id_'+t[i]+"_publishas").is(":checked")){e('div[role="main"] #id_'+t[i]+"_publish_as").css("display","none")}else if(e('div[role="main"] input[name="id"]').val()>0){e('div[role="main"] #id_'+t[i]+"_publishas").attr("disabled","disabled")}}}})},search:function(e,i,t){var o=this;o.watchValue({courseid:i,sectionid:t,target:"#"+e+"-search",uniqid:e,run:function(){var i=this;require(["block_edupublisher/main"],function(e){e.searchNow(i)})}},200)},searchNow:function(a,e){a.subjectareas=[];a.schoollevels=[];a.stars=[];if(typeof e!=="undefined"){if(c(e).attr("name")=="subjectarea"){c(e).toggleClass("selected");c("."+a.uniqid+"-subjectarea").prop("checked",false);c("."+a.uniqid+"-subjectarea.selected").prop("checked",true)}if(c(e).attr("name")=="schoollevel"){c(e).toggleClass("selected");c("."+a.uniqid+"-schoollevel").prop("checked",false);c("."+a.uniqid+"-schoollevel.selected").prop("checked",true)}if(c(e).attr("name")=="stars"){c(e).toggleClass("selected");c("."+a.uniqid+"-stars").prop("checked",false);c("."+a.uniqid+"-stars.selected").prop("checked",true)}}c("."+a.uniqid+"-subjectarea.selected").each(function(){a.subjectareas[a.subjectareas.length]=c(this).attr("value")});c("."+a.uniqid+"-schoollevel.selected").each(function(){a.schoollevels[a.schoollevels.length]=c(this).attr("value")});c("."+a.uniqid+"-stars.selected").each(function(){a.stars[a.stars.length]=c(this).attr("value")});a.search=c("#"+a.uniqid+"-search").val();var i={courseid:a.courseid,search:a.search,schoollevels:a.schoollevels.join("zzzZZZzzz"),subjectareas:a.subjectareas.join("zzzZZZzzz"),stars:a.stars.join("zzzZZZzzz")};require(["block_edupublisher/main"],function(n){n.searchid++;var r=n.searchid;l.call([{methodname:"block_edupublisher_search",args:i,done:function(e){if(n.searchid!=r){}else{var t=c("#"+a.uniqid+"-filterResults").empty();var e=JSON.parse(e);c("ul#"+a.uniqid+"-results").empty();if(e.packages.length===0){s.get_strings([{key:"search:enter_term",component:"block_edupublisher"}]).done(function(e){c("ul#"+a.uniqid+"-results").append(c("<li>").append('<a href="#">').append("<h3>").html(e[0]))}).fail(d.exception)}for(var i=e.packages.length-1;i>=0;i--){var o=e.packages[i];o.importtocourseid=a.courseid;o.importtosectionid=a.sectionid;o.showpreviewbutton=false;o.url=o.wwwroot+"/course/view.php?id="+o.course;u.render("block_edupublisher/search_item",o).then(function(e,i){u.appendNodeContents(t,e,i)}).fail(function(e){console.error(e)})}}},fail:d.exception}])})},searchPrint:function(e){var i=this;var t=true;var o=Object.keys(i.loadpositions[e]);for(var n=0;n<o.length;n++){var r=o[n];if(!i.loadpositions[e][r]){t=false}}if(t){for(var n=0;n<o.length;n++){var r=o[n];u.appendNodeContents("ul#"+e+"-results",i.loadpositions[e][r].html,i.loadpositions[e][r].js)}}},searchTemplate:function(t,o,e,i){var n=this;if(typeof n.loadpositions[t]==="undefined"){n.loadpositions[t]=[]}n.loadpositions[t][o]=false;u.render(e,i).then(function(e,i){n.loadpositions[t][o]={html:e,js:i};n.searchPrint(t)}).fail(function(e){console.error(e)})},storePublisher:function(e,a){var s=this;var i=c("#active-"+e).prop("checked")?1:0;var t=parseInt(c("#id-"+e).val());var o=c("#name-"+e).val();var n=c("#mail-"+e).val();if(o.length==0){return}var r={active:i,id:t,name:o,mail:n};l.call([{methodname:"block_edupublisher_store_publisher",args:r,done:function(e){try{e=JSON.parse(e);var i=Object.keys(e);s.triggerConfirm(c(a).closest("tr"),1,"success");for(var t=0;t<i.length;t++){var o=e[i[t]];var n=c("#publisher-"+o.id);if(n.length==0){var n=c("#publisher-0").attr("id","publisher-"+o.id);var r=c(n).attr("data-uniqid");c(n).find("#id-"+r).val(o.id);c(n).find("#edit-"+r+">*").css("opacity",1).attr("href","/blocks/edupublisher/pages/publishers.php?id="+o.id);u.render("block_edupublisher/publisher",{id:0,name:""}).then(function(e){c(e).insertAfter(c(".edupublisher-publishers").last())}).fail(function(e){d.exception(e)})}else{var r=c(n).attr("data-uniqid");c(n).find("#active-"+r).prop("checked",o.active);c(n).find("#name-"+r).val(o.name);c(n).find("#mail-"+r).val(o.mail)}}}catch(e){console.error("Invalid response");s.triggerConfirm(c(a).closest("tr"),1,"error")}},fail:d.exception}])},storePublisherUsers:function(r,e){var i=c("#publisherid-"+r).val();var t="";if(e=="add"){t=c("#userids-"+r).val()}if(e=="remove"){t=c("#users-"+r).val().join(" ")}var o={action:e,publisherid:i,userids:t};l.call([{methodname:"block_edupublisher_store_publisher_user",args:o,done:function(i){try{i=JSON.parse(i);var e=c("#users-"+r).empty();var t=Object.keys(i);for(var o=0;o<t.length;o++){var n=i[t[o]];c(e).append(c("<option>").attr("value",n.id).html(n.fullname))}}catch(e){console.error("Invalid response",e,i)}},fail:d.exception}])},triggerActive:function(e,i,t){l.call([{methodname:"block_edupublisher_trigger_active",args:{packageid:e,type:i,to:c(t).is(":checked")?1:0},done:function(e){try{e=JSON.parse(e);var i=Object.keys(e);for(var t=0;t<i.length;t++){var o=i[t].split("_");var n=o[0];if(parseInt(e[i[t]])==1){c("#channel-"+n).addClass("channel-active").removeClass("channel-inactive");c("#channel-"+n+"-active").prop("checked",true)}else{c("#channel-"+n).addClass("channel-inactive").removeClass("channel-active");c("#channel-"+n+"-active").prop("checked",false)}}}catch(e){console.error("Invalid response")}},fail:d.exception}])},triggerRating:function(t,e,i){l.call([{methodname:"block_edupublisher_rate",args:{packageid:e,to:i},done:function(e){c("#"+t+"-ratingcount").html(e.amount);for(var i=1;i<=5;i++){c("#"+t+"-rating-"+i).attr("src","/blocks/edupublisher/pix/star_"+(e.average>=i?1:0)+"_"+(e.current==i?1:0)+".png")}},fail:d.exception}])},triggerConfirm:function(e,i,t){var o=this;if(i==1){c(e).addClass("block-edupublisher-"+t);setTimeout(function(){o.triggerConfirm(e,0,t)},2e3)}else{c(e).removeClass("block-edupublisher-"+t)}},watchValue:function(e,i){if(typeof i==="undefined"){i=1e3}if(c(e.target).attr("data-iswatched")!="1"){c(e.target).attr("data-iswatched",1);e.interval=setInterval(function(){if(c(e.target).val()==e.compareto){e.run();clearInterval(e.interval);c(e.target).attr("data-iswatched",0)}else{e.compareto=c(e.target).val()}},i)}}}});