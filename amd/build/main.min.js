define("block_edupublisher/main",["jquery","core/ajax","core/notification","core/str","core/templates","core/url","core/modal_factory"],(function($,AJAX,NOTIFICATION,STR,TEMPLATES,URL,ModalFactory){return{searchid:0,loadpositions:{},clickImportConfirmation:function(){$('#page-content div[role="main"] form[action*="/edupublisher/pages/import.php"]').submit()},confirmDeleteGroup:function(url){STR.get_strings([{key:"groups:remove:title",component:"block_edupublisher"},{key:"groups:remove:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done((function(s){NOTIFICATION.confirm(s[0],s[1],s[2],s[3],(function(){top.location.href=url}))})).fail(NOTIFICATION.exception)},confirmRemoval:function(url){STR.get_strings([{key:"removal:title",component:"block_edupublisher"},{key:"removal:text",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done((function(s){NOTIFICATION.confirm(s[0],s[1],s[2],s[3],(function(){top.location.href=url}))})).fail(NOTIFICATION.exception)},exportCourseWarning:function(){$("#id_exportcourse").is(":checked")||STR.get_strings([{key:"exportcourse",component:"block_edupublisher"},{key:"exportcourse_help",component:"block_edupublisher"},{key:"yes"},{key:"no"}]).done((function(s){NOTIFICATION.confirm(s[0],s[1],s[2],s[3],(function(){}),(function(){$("#id_exportcourse").prop("checked",!0)}))})).fail(NOTIFICATION.exception)},initImportSelection:function(packageid,courseid,allowsubcourses){STR.get_strings([{key:"import",component:"core"}]).done((function(s){ModalFactory.create({title:s[0],body:TEMPLATES.render("block_edupublisher/init_import_selection",{packageid:packageid,courseid:courseid,allowsubcourses:allowsubcourses})}).done((function(modal){modal.show()}))})).fail(NOTIFICATION.exception)},initImportLoadGo:function(uniqid){var courseid=$("#courseid-"+uniqid).val(),packageid=$("#packageid-"+uniqid).val(),sectionid=$("#sectionid-"+uniqid).val(),assubcourse=$("#assubcourse-"+uniqid).prop("checked")?1:0;top.location.href=URL.fileUrl("/blocks/edupublisher/pages/import.php","?package="+packageid+"&course="+courseid+"&section="+sectionid+"&assubcourse="+assubcourse)},initImportLoadCourses:function(uniqid,initial){var MAIN=this;$("#courseid-"+uniqid).empty().attr("disabled","disabled"),$("#sectionid-"+uniqid).empty().attr("disabled","disabled");var packageid=+$("#packageid-"+uniqid).val();STR.get_strings([{key:"loading",component:"core"}]).done((function(s){$("#courseid-"+uniqid+", #sectionid-"+uniqid).append($("<option>").html(s[0])),AJAX.call([{methodname:"block_edupublisher_init_import_load_courses",args:{packageid:packageid},done:function(result){result=JSON.parse(result);if($("#courseid-"+uniqid).empty(),void 0!==result.courses&&Object.keys(result.courses).length>0){$("#courseid-"+uniqid).removeAttr("disabled");var first=0;Object.keys(result.courses).forEach((function(courseid){var c=result.courses[courseid],opt=$("<option>").attr("value",c.id).html(c.fullname);$("#courseid-"+uniqid).append(opt),0==first&&void 0!==initial&&(first=c.id),void 0!==initial&&initial==c.id&&opt.attr("selected","selected")})),MAIN.initImportLoadSections(uniqid)}else STR.get_strings([{key:"error",component:"core"}]).done((function(s){$("#courseid-"+uniqid).append($("<option>").html(s[0])),$("#sectionid-"+uniqid).append($("<option>").html(s[0]))})).fail(NOTIFICATION.exception),NOTIFICATION.show("error","no courses")},fail:NOTIFICATION.exception}])})).fail(NOTIFICATION.exception)},initImportLoadSections:function(uniqid){$("#sectionid-"+uniqid).empty().attr("disabled","disabled"),STR.get_strings([{key:"loading",component:"core"}]).done((function(s){$("#sectionid-"+uniqid).append($("<option>").html(s[0])),AJAX.call([{methodname:"block_edupublisher_init_import_load_sections",args:{courseid:+$("#courseid-"+uniqid).val()},done:function(result){result=JSON.parse(result);if($("#sectionid-"+uniqid).empty(),void 0!==result.sections&&Object.keys(result.sections).length>0){$("#sectionid-"+uniqid).removeAttr("disabled");var i=0;Object.keys(result.sections).forEach((function(sectionid){var s=result.sections[sectionid];s.name||(s.name="#"+i),$("#sectionid-"+uniqid).append($("<option>").attr("value",s.id).html(s.name)),i++}))}else STR.get_strings([{key:"error",component:"core"}]).done((function(s){$("#sectionid-"+uniqid).append($("<option>").html(s[0]))})).fail(NOTIFICATION.exception)},fail:NOTIFICATION.exception}])})).fail(NOTIFICATION.exception)},injectEnrolButton:function(courseid,isguestuser){var context={isguestuser:isguestuser,url:URL.relativeUrl("/blocks/edupublisher/pages/self_enrol.php",{id:courseid})};TEMPLATES.render("block_edupublisher/inject_enrol_button",context).then((function(html,js){TEMPLATES.prependNodeContents("#page-content #region-main-box",html,js),$(".course-guestaccess-infobox").remove()})).fail(NOTIFICATION.exception)},search:function(uniqid,courseid,sectionid){this.watchValue({courseid:courseid,sectionid:sectionid,target:"#"+uniqid+"-search",uniqid:uniqid,run:function(){var o=this;require(["block_edupublisher/main"],(function(MAIN){MAIN.searchNow(o)}))}},200)},searchNow:function(o,sender){o.subjectareas=[],o.schoollevels=[],o.stars=[],void 0!==sender&&("subjectarea"==$(sender).attr("name")&&($(sender).toggleClass("selected"),$("."+o.uniqid+"-subjectarea").prop("checked",!1),$("."+o.uniqid+"-subjectarea.selected").prop("checked",!0)),"schoollevel"==$(sender).attr("name")&&($(sender).toggleClass("selected"),$("."+o.uniqid+"-schoollevel").prop("checked",!1),$("."+o.uniqid+"-schoollevel.selected").prop("checked",!0)),"stars"==$(sender).attr("name")&&($(sender).toggleClass("selected"),$("."+o.uniqid+"-stars").prop("checked",!1),$("."+o.uniqid+"-stars.selected").prop("checked",!0))),$("."+o.uniqid+"-subjectarea.selected").each((function(){o.subjectareas[o.subjectareas.length]=$(this).attr("value")})),$("."+o.uniqid+"-schoollevel.selected").each((function(){o.schoollevels[o.schoollevels.length]=$(this).attr("value")})),$("."+o.uniqid+"-stars.selected").each((function(){o.stars[o.stars.length]=$(this).attr("value")})),o.search=$("#"+o.uniqid+"-search").val();var o2={courseid:o.courseid,search:o.search,schoollevels:o.schoollevels.join("zzzZZZzzz"),subjectareas:o.subjectareas.join("zzzZZZzzz"),stars:o.stars.join("zzzZZZzzz")};require(["block_edupublisher/main"],(function(MAIN){MAIN.searchid++;var searchid=MAIN.searchid;AJAX.call([{methodname:"block_edupublisher_search",args:o2,done:function(result){if(MAIN.searchid!=searchid);else{var container=$("#"+o.uniqid+"-filterResults").empty();result=JSON.parse(result);$("ul#"+o.uniqid+"-results").empty(),0===result.packages.length&&STR.get_strings([{key:"search:enter_term",component:"block_edupublisher"}]).done((function(s){$("ul#"+o.uniqid+"-results").append($("<li>").append('<a href="#">').append("<h3>").html(s[0]))})).fail(NOTIFICATION.exception);for(var a=result.packages.length-1;a>=0;a--){var item=result.packages[a];item.importtocourseid=o.courseid,item.importtosectionid=o.sectionid,item.showpreviewbutton=!1,item.url=M.cfg.wwwroot+"/course/view.php?id="+item.course,TEMPLATES.render("block_edupublisher/search_item",item).then((function(html,js){TEMPLATES.appendNodeContents(container,html,js)})).fail((function(ex){console.error(ex)}))}}},fail:NOTIFICATION.exception}])}))},searchPrint:function(uniqid){for(var ok=!0,positions=Object.keys(this.loadpositions[uniqid]),a=0;a<positions.length;a++){var position=positions[a];this.loadpositions[uniqid][position]||(ok=!1)}if(ok)for(a=0;a<positions.length;a++){position=positions[a];TEMPLATES.appendNodeContents("ul#"+uniqid+"-results",this.loadpositions[uniqid][position].html,this.loadpositions[uniqid][position].js)}},searchTemplate:function(uniqid,position,template,o){var MAIN=this;void 0===MAIN.loadpositions[uniqid]&&(MAIN.loadpositions[uniqid]=[]),MAIN.loadpositions[uniqid][position]=!1,TEMPLATES.render(template,o).then((function(html,js){MAIN.loadpositions[uniqid][position]={html:html,js:js},MAIN.searchPrint(uniqid)})).fail((function(ex){console.error(ex)}))},storePublisher:function(uniqid,sender){var self=this,active=$("#active-"+uniqid).prop("checked")?1:0,id=parseInt($("#id-"+uniqid).val()),name=$("#name-"+uniqid).val(),mail=$("#mail-"+uniqid).val();if(0!=name.length){var data={active:active,id:id,name:name,mail:mail};AJAX.call([{methodname:"block_edupublisher_store_publisher",args:data,done:function(result){try{result=JSON.parse(result);var publishers=Object.keys(result);self.triggerConfirm($(sender).closest("tr"),1,"success");for(var a=0;a<publishers.length;a++){var publisher=result[publishers[a]];if(0==(form=$("#publisher-"+publisher.id)).length){var form=$("#publisher-0").attr("id","publisher-"+publisher.id),uniqid=$(form).attr("data-uniqid");$(form).find("#id-"+uniqid).val(publisher.id),$(form).find("#edit-"+uniqid+">*").css("opacity",1).attr("href","/blocks/edupublisher/pages/publishers.php?id="+publisher.id),TEMPLATES.render("block_edupublisher/publisher",{id:0,name:""}).then((function(html){$(html).insertAfter($(".edupublisher-publishers").last())})).fail((function(ex){NOTIFICATION.exception(ex)}))}else{uniqid=$(form).attr("data-uniqid");$(form).find("#active-"+uniqid).prop("checked",publisher.active),$(form).find("#name-"+uniqid).val(publisher.name),$(form).find("#mail-"+uniqid).val(publisher.mail)}}}catch(e){console.error("Invalid response"),self.triggerConfirm($(sender).closest("tr"),1,"error")}},fail:NOTIFICATION.exception}])}},storePublisherUsers:function(uniqid,action){var publisherid=$("#publisherid-"+uniqid).val(),userids="";"add"==action&&(userids=$("#userids-"+uniqid).val()),"remove"==action&&(userids=$("#users-"+uniqid).val().join(" "));var data={action:action,publisherid:publisherid,userids:userids};AJAX.call([{methodname:"block_edupublisher_store_publisher_user",args:data,done:function(result){try{result=JSON.parse(result);for(var sel=$("#users-"+uniqid).empty(),users=Object.keys(result),a=0;a<users.length;a++){var user=result[users[a]];$(sel).append($("<option>").attr("value",user.id).html(user.fullname))}}catch(e){console.error("Invalid response",e,result)}},fail:NOTIFICATION.exception}])},triggerActive:function(packageid,type,sender){AJAX.call([{methodname:"block_edupublisher_trigger_active",args:{packageid:packageid,type:type,to:$(sender).is(":checked")?1:0},done:function(result){try{result=JSON.parse(result);for(var chans=Object.keys(result),a=0;a<chans.length;a++){var type=chans[a].split("_")[0];1==parseInt(result[chans[a]])?($("#channel-"+type).addClass("channel-active").removeClass("channel-inactive"),$("#channel-"+type+"-active").prop("checked",!0)):($("#channel-"+type).addClass("channel-inactive").removeClass("channel-active"),$("#channel-"+type+"-active").prop("checked",!1))}}catch(e){console.error("Invalid response")}},fail:NOTIFICATION.exception}])},triggerRating:function(uniqid,packageid,to){AJAX.call([{methodname:"block_edupublisher_rate",args:{packageid:packageid,to:to},done:function(result){$("#"+uniqid+"-ratingcount").html(result.amount);for(var a=1;a<=5;a++)$("#"+uniqid+"-rating-"+a).attr("src","/blocks/edupublisher/pix/star_"+(result.average>=a?1:0)+"_"+(result.current==a?1:0)+".png")},fail:NOTIFICATION.exception}])},triggerConfirm:function(sender,step,type){var self=this;1==step?($(sender).addClass("block-edupublisher-"+type),setTimeout((function(){self.triggerConfirm(sender,0,type)}),2e3)):$(sender).removeClass("block-edupublisher-"+type)},watchValue:function(o,interval){void 0===interval&&(interval=1e3),"1"!=$(o.target).attr("data-iswatched")&&($(o.target).attr("data-iswatched",1),o.interval=setInterval((function(){$(o.target).val()==o.compareto?(o.run(),clearInterval(o.interval),$(o.target).attr("data-iswatched",0)):o.compareto=$(o.target).val()}),interval))}}}));

//# sourceMappingURL=main.min.js.map